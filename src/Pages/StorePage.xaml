<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:viewmodels="clr-namespace:MauiStream.ViewModels"
             xmlns:models="clr-namespace:MauiStream.Models"
             xmlns:controls="clr-namespace:MauiStream.Controls"
             x:Class="MauiStream.Pages.StorePage"
             x:DataType="viewmodels:StoreViewModel"
             BackgroundColor="{StaticResource SteamDarkBlue}">

    <Grid RowDefinitions="Auto,*">
        <!-- Header Bar -->
        <Grid Grid.Row="0"
              BackgroundColor="{StaticResource SteamDarkerBlue}"
              Padding="15,10"
              HeightRequest="56">
            
            <!-- Main Header Content (fades out when search expands) -->
            <Grid x:Name="HeaderContent"
                  ColumnDefinitions="Auto,*,Auto,Auto,Auto"
                  ColumnSpacing="12">
                
                <!-- Steam Logo with text -->
                <Image Grid.Column="0" 
                       Source="steamheader.png"
                       HeightRequest="30"
                       Aspect="AspectFit"
                       VerticalOptions="Center"/>
                
                <!-- Collapsed Search Button -->
                <Border x:Name="CollapsedSearch"
                        Grid.Column="1"
                        BackgroundColor="{StaticResource SteamSearchBackground}"
                        StrokeThickness="0"
                        Padding="12,8"
                        HorizontalOptions="Fill"
                        VerticalOptions="Center">
                    <Border.StrokeShape>
                        <RoundRectangle CornerRadius="8"/>
                    </Border.StrokeShape>
                    <Border.GestureRecognizers>
                        <TapGestureRecognizer Tapped="OnSearchTapped"/>
                    </Border.GestureRecognizers>
                    <HorizontalStackLayout Spacing="8">
                        <!-- Magnifying glass icon -->
                        <Grid WidthRequest="16" HeightRequest="16">
                            <Path Data="M15.5,14 L20.5,19 M10,4 A6,6 0 1,1 10,16 A6,6 0 1,1 10,4"
                                  Stroke="{StaticResource SteamTextDark}"
                                  StrokeThickness="1.8"
                                  StrokeLineCap="Round"
                                  Aspect="Uniform"
                                  HorizontalOptions="Center"
                                  VerticalOptions="Center"/>
                        </Grid>
                        <Label Text="Search"
                               TextColor="{StaticResource SteamTextDark}"
                               FontSize="14"
                               VerticalOptions="Center"/>
                    </HorizontalStackLayout>
                </Border>
                
                <!-- Notification bell -->
                <Grid Grid.Column="2" WidthRequest="28" HeightRequest="28">
                    <Path Data="M12,2 C13.1,2 14,2.9 14,4 L14,4.29 C16.89,5.15 19,7.83 19,11 L19,17 L21,19 L3,19 L5,17 L5,11 C5,7.83 7.11,5.15 10,4.29 L10,4 C10,2.9 10.9,2 12,2 Z M12,22 C10.9,22 10,21.1 10,20 L14,20 C14,21.1 13.1,22 12,22 Z"
                          Fill="{StaticResource SteamTextLight}"
                          Aspect="Uniform"
                          WidthRequest="22"
                          HeightRequest="22"
                          HorizontalOptions="Center"
                          VerticalOptions="Center"/>
                    <!-- Red notification dot -->
                    <Ellipse WidthRequest="8" HeightRequest="8" Fill="#e74c3c" 
                             HorizontalOptions="End" VerticalOptions="Start" Margin="0,2,2,0"/>
                </Grid>
                
                <!-- Shopping cart -->
                <Grid Grid.Column="3" WidthRequest="28" HeightRequest="28">
                    <Path Data="M7,18 C5.9,18 5,18.9 5,20 C5,21.1 5.9,22 7,22 C8.1,22 9,21.1 9,20 C9,18.9 8.1,18 7,18 Z M1,2 L1,4 L3,4 L6.6,11.59 L5.25,14.04 C5.09,14.32 5,14.65 5,15 C5,16.1 5.9,17 7,17 L19,17 L19,15 L7.42,15 C7.28,15 7.17,14.89 7.17,14.75 L7.2,14.63 L8.1,13 L15.55,13 C16.3,13 16.96,12.59 17.3,11.97 L20.88,5.48 C20.96,5.34 21,5.17 21,5 C21,4.45 20.55,4 20,4 L5.21,4 L4.27,2 L1,2 Z M17,18 C15.9,18 15,18.9 15,20 C15,21.1 15.9,22 17,22 C18.1,22 19,21.1 19,20 C19,18.9 18.1,18 17,18 Z"
                          Fill="{StaticResource SteamTextLight}"
                          Aspect="Uniform"
                          WidthRequest="22"
                          HeightRequest="22"
                          HorizontalOptions="Center"
                          VerticalOptions="Center"/>
                </Grid>
                
                <!-- Profile picture mockup -->
                <HorizontalStackLayout Grid.Column="4" Spacing="8" VerticalOptions="Center">
                    <Border StrokeThickness="0"
                            WidthRequest="34"
                            HeightRequest="34">
                        <Border.StrokeShape>
                            <RoundRectangle CornerRadius="17"/>
                        </Border.StrokeShape>
                        <Grid>
                            <!-- Gradient background for profile -->
                            <BoxView>
                                <BoxView.Background>
                                    <LinearGradientBrush StartPoint="0,0" EndPoint="1,1">
                                        <GradientStop Color="#e67e22" Offset="0.0"/>
                                        <GradientStop Color="#d35400" Offset="1.0"/>
                                    </LinearGradientBrush>
                                </BoxView.Background>
                            </BoxView>
                            <!-- Profile silhouette -->
                            <Path Data="M12,4 C14.21,4 16,5.79 16,8 C16,10.21 14.21,12 12,12 C9.79,12 8,10.21 8,8 C8,5.79 9.79,4 12,4 Z M12,14 C16.42,14 20,15.79 20,18 L20,20 L4,20 L4,18 C4,15.79 7.58,14 12,14 Z"
                                  Fill="White"
                                  Opacity="0.9"
                                  Aspect="Uniform"
                                  WidthRequest="20"
                                  HeightRequest="20"
                                  HorizontalOptions="Center"
                                  VerticalOptions="Center"/>
                        </Grid>
                    </Border>
                    <Label Text="▾"
                           TextColor="{StaticResource SteamTextLight}"
                           FontSize="12"
                           VerticalOptions="Center"/>
                </HorizontalStackLayout>
            </Grid>
            
            <!-- Expanded Search Overlay (initially hidden) -->
            <Grid x:Name="ExpandedSearch"
                  IsVisible="False"
                  Opacity="0"
                  ColumnDefinitions="*,Auto"
                  ColumnSpacing="12"
                  VerticalOptions="Center">
                
                <Border Grid.Column="0"
                        BackgroundColor="{StaticResource SteamSearchBackground}"
                        StrokeThickness="0"
                        Padding="8,4"
                        HeightRequest="40"
                        HorizontalOptions="Fill"
                        VerticalOptions="Center">
                    <Border.StrokeShape>
                        <RoundRectangle CornerRadius="8"/>
                    </Border.StrokeShape>
                    <Grid ColumnDefinitions="Auto,*" ColumnSpacing="8" VerticalOptions="Center">
                        <!-- Magnifying glass icon -->
                        <Grid WidthRequest="20" HeightRequest="20" VerticalOptions="Center">
                            <Path Data="M15.5,14 L20.5,19 M10,4 A6,6 0 1,1 10,16 A6,6 0 1,1 10,4"
                                  Stroke="{StaticResource SteamTextDark}"
                                  StrokeThickness="1.8"
                                  StrokeLineCap="Round"
                                  Aspect="Uniform"
                                  HorizontalOptions="Center"
                                  VerticalOptions="Center"/>
                        </Grid>
                        <Entry x:Name="SearchEntry"
                               Grid.Column="1"
                               Placeholder="Search games, tags, genres..."
                               PlaceholderColor="{StaticResource SteamTextDark}"
                               TextColor="{StaticResource SteamTextLight}"
                               BackgroundColor="Transparent"
                               FontSize="15"
                               ReturnType="Search"
                               VerticalOptions="Center"
                               VerticalTextAlignment="Center"
                               MinimumHeightRequest="0"
                               Margin="0"
                               Completed="OnSearchCompleted"/>
                    </Grid>
                </Border>
                
                <Label Grid.Column="1"
                       Text="Cancel"
                       TextColor="{StaticResource SteamLightBlue}"
                       FontSize="15"
                       FontAttributes="Bold"
                       VerticalOptions="Center">
                    <Label.GestureRecognizers>
                        <TapGestureRecognizer Tapped="OnSearchCancelTapped"/>
                    </Label.GestureRecognizers>
                </Label>
            </Grid>
        </Grid>

        <!-- Main Content -->
        <ScrollView Grid.Row="1">
            <ScrollView.GestureRecognizers>
                <TapGestureRecognizer Tapped="OnOutsideTapped"/>
            </ScrollView.GestureRecognizers>
            <VerticalStackLayout Spacing="0" Padding="0,12,0,0">

                <!-- Featured Game Carousel -->
                <Grid Padding="15,0" HeightRequest="320">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>
                    
                    <!-- Carousel -->
                    <Border x:Name="CarouselBorder"
                            Grid.Column="0" 
                            StrokeThickness="0"
                            Margin="0,0,10,0">
                        <Border.StrokeShape>
                            <RoundRectangle CornerRadius="12"/>
                        </Border.StrokeShape>
                        <Grid>
                            <CarouselView x:Name="FeaturedCarousel"
                                          ItemsSource="{Binding FeaturedGames}"
                                          CurrentItemChanged="OnCarouselCurrentItemChanged"
                                          Loop="True"
                                          HeightRequest="320">
                                <CarouselView.ItemTemplate>
                                    <DataTemplate x:DataType="models:Game">
                                        <Grid>
                                            <Grid.GestureRecognizers>
                                                <TapGestureRecognizer Tapped="OnFeaturedGameTapped" CommandParameter="{Binding .}"/>
                                            </Grid.GestureRecognizers>
                                            <Image Source="{Binding ImageUrl}"
                                                   Aspect="AspectFill"/>
                                            
                                            <!-- Gradient Overlay -->
                                            <BoxView>
                                                <BoxView.Background>
                                                    <LinearGradientBrush StartPoint="0,0" EndPoint="0,1">
                                                        <GradientStop Color="Transparent" Offset="0.3"/>
                                                        <GradientStop Color="#DD000000" Offset="1.0"/>
                                                    </LinearGradientBrush>
                                                </BoxView.Background>
                                            </BoxView>
                                            
                                            <!-- Game Tags at Top -->
                                            <ScrollView Orientation="Horizontal"
                                                        HorizontalScrollBarVisibility="Never"
                                                        VerticalOptions="Start"
                                                        Padding="12,12,12,0">
                                                <HorizontalStackLayout Spacing="8"
                                                                       BindableLayout.ItemsSource="{Binding Tags}">
                                                    <BindableLayout.ItemTemplate>
                                                        <DataTemplate x:DataType="x:String">
                                                            <Border BackgroundColor="#88000000"
                                                                    StrokeThickness="0"
                                                                    Padding="12,6">
                                                                <Border.StrokeShape>
                                                                    <RoundRectangle CornerRadius="14"/>
                                                                </Border.StrokeShape>
                                                                <Label Text="{Binding .}"
                                                                       TextColor="White"
                                                                       FontSize="12"/>
                                                            </Border>
                                                        </DataTemplate>
                                                    </BindableLayout.ItemTemplate>
                                                </HorizontalStackLayout>
                                            </ScrollView>
                                            
                                            <!-- Game Title Overlay -->
                                            <VerticalStackLayout VerticalOptions="End"
                                                                 Padding="20"
                                                                 Spacing="8">
                                                <Label Text="{Binding Title}"
                                                       TextColor="White"
                                                       FontSize="32"
                                                       FontAttributes="Bold"/>
                                                
                                                <!-- Translucent friends pill -->
                                                <Border BackgroundColor="#88000000" StrokeThickness="0" Padding="8,6" HorizontalOptions="Start">
                                                    <Border.StrokeShape>
                                                        <RoundRectangle CornerRadius="16"/>
                                                    </Border.StrokeShape>
                                                    <HorizontalStackLayout Spacing="6">
                                                        <!-- Friend avatars mockup -->
                                                        <HorizontalStackLayout Spacing="-6">
                                                            <!-- Friend 1 - Blue gradient -->
                                                            <Border WidthRequest="22" HeightRequest="22" StrokeThickness="1.5" Stroke="White">
                                                                <Border.StrokeShape><RoundRectangle CornerRadius="11"/></Border.StrokeShape>
                                                                <BoxView>
                                                                    <BoxView.Background>
                                                                        <LinearGradientBrush StartPoint="0,0" EndPoint="1,1">
                                                                            <GradientStop Color="#3498db" Offset="0.0"/>
                                                                            <GradientStop Color="#2980b9" Offset="1.0"/>
                                                                        </LinearGradientBrush>
                                                                    </BoxView.Background>
                                                                </BoxView>
                                                            </Border>
                                                            <!-- Friend 2 - Green gradient -->
                                                            <Border WidthRequest="22" HeightRequest="22" StrokeThickness="1.5" Stroke="White">
                                                                <Border.StrokeShape><RoundRectangle CornerRadius="11"/></Border.StrokeShape>
                                                                <BoxView>
                                                                    <BoxView.Background>
                                                                        <LinearGradientBrush StartPoint="0,0" EndPoint="1,1">
                                                                            <GradientStop Color="#27ae60" Offset="0.0"/>
                                                                            <GradientStop Color="#1e8449" Offset="1.0"/>
                                                                        </LinearGradientBrush>
                                                                    </BoxView.Background>
                                                                </BoxView>
                                                            </Border>
                                                            <!-- Friend 3 - Purple gradient -->
                                                            <Border WidthRequest="22" HeightRequest="22" StrokeThickness="1.5" Stroke="White">
                                                                <Border.StrokeShape><RoundRectangle CornerRadius="11"/></Border.StrokeShape>
                                                                <BoxView>
                                                                    <BoxView.Background>
                                                                        <LinearGradientBrush StartPoint="0,0" EndPoint="1,1">
                                                                            <GradientStop Color="#9b59b6" Offset="0.0"/>
                                                                            <GradientStop Color="#8e44ad" Offset="1.0"/>
                                                                        </LinearGradientBrush>
                                                                    </BoxView.Background>
                                                                </BoxView>
                                                            </Border>
                                                        </HorizontalStackLayout>
                                                        <Label Text="{Binding FriendCount, StringFormat='{0} friends'}"
                                                               TextColor="White"
                                                               FontSize="12"
                                                               VerticalOptions="Center"/>
                                                    </HorizontalStackLayout>
                                                </Border>
                                            </VerticalStackLayout>
                                        </Grid>
                                    </DataTemplate>
                                </CarouselView.ItemTemplate>
                            </CarouselView>
                        </Grid>
                    </Border>
                    
                    <!-- Game Info Panel -->
                    <Border x:Name="DetailPanel"
                            Grid.Column="1"
                            BackgroundColor="{StaticResource SteamCardDark}"
                            StrokeThickness="0"
                            WidthRequest="160">
                        <Border.StrokeShape>
                            <RoundRectangle CornerRadius="12"/>
                        </Border.StrokeShape>
                        <controls:GameDetailContent Game="{Binding CurrentFeaturedGame}" ShowImage="False" ShowMoreLikeThis="False" ShowTitle="False" ShowTags="False"/>
                    </Border>
                </Grid>

                <!-- Carousel Indicators -->
                <IndicatorView x:Name="CarouselIndicator"
                               ItemsSource="{Binding FeaturedGames}"
                               IndicatorColor="{StaticResource SteamTextDark}"
                               SelectedIndicatorColor="{StaticResource SteamGreen}"
                               HorizontalOptions="Center"
                               Margin="0,10,0,0"
                               IndicatorSize="8"/>

                <!-- Special Offers Section -->
                <VerticalStackLayout Padding="15,20" Spacing="15">
                    <Grid ColumnDefinitions="*,Auto">
                        <Label Grid.Column="0"
                               Text="Special offers"
                               FontSize="20"
                               FontAttributes="Bold"
                               TextColor="{StaticResource SteamTextLight}"/>
                        <Label Grid.Column="1"
                               Text="Learn more"
                               FontSize="14"
                               TextColor="{StaticResource SteamLightBlue}"
                               VerticalOptions="Center"/>
                    </Grid>

                    <CollectionView ItemsSource="{Binding SpecialOffers}">
                        <CollectionView.HeightRequest>
                            <OnPlatform x:TypeArguments="x:Double">
                                <On Platform="Android" Value="290"/>
                                <On Platform="iOS" Value="220"/>
                            </OnPlatform>
                        </CollectionView.HeightRequest>
                        <CollectionView.ItemsLayout>
                            <LinearItemsLayout Orientation="Horizontal" ItemSpacing="12"/>
                        </CollectionView.ItemsLayout>
                        <CollectionView.ItemTemplate>
                            <DataTemplate x:DataType="models:Game">
                                <Border StrokeThickness="0"
                                        WidthRequest="140"
                                        HeightRequest="200">
                                    <Border.StrokeShape>
                                        <RoundRectangle CornerRadius="10"/>
                                    </Border.StrokeShape>
                                    <Border.GestureRecognizers>
                                        <TapGestureRecognizer Tapped="OnSpecialOfferTapped" CommandParameter="{Binding .}"/>
                                    </Border.GestureRecognizers>
                                    
                                    <Grid>
                                        <Image Source="{Binding ImageUrl}"
                                               Aspect="AspectFill"/>
                                        
                                        <!-- Gradient Overlay -->
                                        <BoxView>
                                            <BoxView.Background>
                                                <LinearGradientBrush StartPoint="0,0" EndPoint="0,1">
                                                    <GradientStop Color="Transparent" Offset="0.5"/>
                                                    <GradientStop Color="#EE000000" Offset="1.0"/>
                                                </LinearGradientBrush>
                                            </BoxView.Background>
                                        </BoxView>
                                        
                                        <!-- Discount Badge -->
                                        <Border IsVisible="{Binding HasDiscount}"
                                                BackgroundColor="{StaticResource SteamGreen}"
                                                StrokeThickness="0"
                                                Padding="6,3"
                                                HorizontalOptions="Start"
                                                VerticalOptions="Start"
                                                Margin="8">
                                            <Border.StrokeShape>
                                                <RoundRectangle CornerRadius="3"/>
                                            </Border.StrokeShape>
                                            <Label Text="{Binding DiscountPercent, StringFormat='-{0}%'}"
                                                   TextColor="White"
                                                   FontSize="11"
                                                   FontAttributes="Bold"/>
                                        </Border>
                                        
                                        <!-- Game Info -->
                                        <VerticalStackLayout VerticalOptions="End"
                                                             Padding="10"
                                                             Spacing="2">
                                            <Label Text="{Binding Title}"
                                                   TextColor="White"
                                                   FontSize="13"
                                                   FontAttributes="Bold"
                                                   LineBreakMode="TailTruncation"
                                                   MaxLines="2"/>
                                        </VerticalStackLayout>
                                    </Grid>
                                </Border>
                            </DataTemplate>
                        </CollectionView.ItemTemplate>
                    </CollectionView>
                </VerticalStackLayout>
                
            </VerticalStackLayout>
        </ScrollView>

        <!-- Game Details Popup Overlay -->
        <Grid x:Name="PopupOverlay"
              Grid.RowSpan="2"
              IsVisible="False"
              InputTransparent="False">
            
            <!-- Semi-transparent background -->
            <BoxView BackgroundColor="{StaticResource SteamOverlay}">
                <BoxView.GestureRecognizers>
                    <TapGestureRecognizer Tapped="OnPopupOverlayTapped"/>
                </BoxView.GestureRecognizers>
            </BoxView>
            
            <!-- Popup Panel (slides up from bottom, takes most of screen) -->
            <Border x:Name="PopupPanel"
                    BackgroundColor="{StaticResource SteamPopupBackground}"
                    StrokeThickness="0"
                    VerticalOptions="Fill"
                    Margin="0,50,0,0"
                    TranslationY="800">
                <Border.StrokeShape>
                    <RoundRectangle CornerRadius="24,24,0,0"/>
                </Border.StrokeShape>
                
                <Grid RowDefinitions="Auto,*">
                    <!-- Close button header with drag indicator -->
                    <VerticalStackLayout Spacing="8" Padding="0,12,0,0">
                        <!-- Drag indicator -->
                        <BoxView WidthRequest="40" 
                                 HeightRequest="4" 
                                 BackgroundColor="{StaticResource SteamTextDark}"
                                 CornerRadius="2"
                                 HorizontalOptions="Center"
                                 Opacity="0.5"/>
                        <Grid Padding="20,8,20,12">
                            <Label Text="Game Details"
                                   TextColor="White"
                                   FontSize="18"
                                   FontAttributes="Bold"
                                   VerticalOptions="Center"/>
                            <Border BackgroundColor="{StaticResource SteamSearchBackground}"
                                    StrokeThickness="0"
                                    HorizontalOptions="End"
                                    WidthRequest="36"
                                    HeightRequest="36">
                                <Border.StrokeShape>
                                    <RoundRectangle CornerRadius="18"/>
                                </Border.StrokeShape>
                                <Border.GestureRecognizers>
                                    <TapGestureRecognizer Tapped="OnPopupCloseTapped"/>
                                </Border.GestureRecognizers>
                                <Label Text="✕"
                                       TextColor="{StaticResource SteamTextLight}"
                                       FontSize="16"
                                       HorizontalOptions="Center"
                                       VerticalOptions="Center"/>
                            </Border>
                        </Grid>
                    </VerticalStackLayout>
                    
                    <!-- Game detail content in scrollable area -->
                    <ScrollView Grid.Row="1" Padding="5,0">
                        <controls:GameDetailContent x:Name="PopupContent"
                                                    Game="{Binding PopupGame}"/>
                    </ScrollView>
                </Grid>
            </Border>
        </Grid>
    </Grid>
</ContentPage>
